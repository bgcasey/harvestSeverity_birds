```{r setup, include=FALSE, cache=FALSE}
#Set root directory to R project root
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Load data {-}

```{r eval=FALSE}

library(dplyr)

# GEE landcover
load("0_data/manual/gee_landcover.rData")
gee_landcover<-gee_landcover%>%
  dplyr::rename(survey_year=srvy_yr)

# Harvest
load("0_data/manual/spatial/ss_xy_harvest_df_2023-03-16.rData")

# Bird community
load("0_data/manual/bird/bd_community_2023-02-10.rData")

# NBR from ABMI polygons
load("0_data/manual/gee_tables/finalFullTable_flag.rData")

```


## Join bird data and spatial data

```{r eval=FALSE}

bd_cov<-bd_community%>%
  left_join(gee_landcover, by = c("SS", "survey_year"))%>%
  distinct()%>% #29989
  left_join(ss_xy_harvest_df)%>% #30057
  left_join(nbr_flagData)%>% #30057
  dplyr::select(-c(x, y))%>%
  mutate(sampling_intensity=MAXDUR*n_count)%>%
  rename_all(funs(stringr::str_replace_all(., "_mean", '')))%>%
  mutate(NBR_yod=round(yod))%>%
  mutate(ss_dst_timelag=survey_year-round(dist_yr_1, 0))%>%
  mutate(ss_dst_timelag_nbr=survey_year-round(NBR_yod, 0))%>%
  mutate(ss_dst_timelag=survey_year-round(dist_yr_1, 0))%>%
  mutate(dist_date_dif=ss_dst_timelag_nbr-ss_dst_timelag)%>%
  filter(!is.na(preDistMean)) #for low confidence NBR yod use cas-fri yod %>%
  
save(bd_cov, file=paste0("0_data/manual/for_models/bd_cov_", Sys.Date(), ".rData"))

load("0_data/manual/for_models/bd_cov_2023-03-16.rData")
```

## Clean data {-}

```{r eval=FALSE}

#Keep only relevant columns
bd_cov_2<-bd_cov%>%
  dplyr::select(SS, HFI_ID, survey_year,YEAR,  
  NBR_yod, ss_dst_timelag_nbr,  sampling_intensity, surveyType, richness, menhIndx, margIndx,
  shan, brill, simp, 
  pilou, hill, nbsp, 
  sing.sp, FRic, qual.FRic, 
  FEve, FDiv, FDis, 
  RaoQ, Broadleaf, Bryoids, 
  Coniferous, Exposed_Barren_land, Herbs, 
  Mixedwood, Rock_Rubble, Shrubs, 
  Snow_Ice, Unclassified, Water, 
  Wetland, "Wetland-treed", canopy_height, 
  canopy_standard_deviation, lat, 
  dist_to_edge,
  perimeter, area, 
  pa_ratio, preDistMean, 
  totDistb, relDistbVal, yodConf,  sumConf, flag_pixels)%>%
  rename(Wetland_treed="Wetland-treed")%>%
  distinct()%>% 
  # keep the greates sampling intensity per station
  group_by(SS, survey_year) %>% 
  rename(c(dNBR=totDistb, RdNBR=relDistbVal))%>%
  mutate(dNBR_perc=dNBR/preDistMean)%>%
  dplyr::select(-preDistMean)%>%
  top_n(1, sampling_intensity)%>%
  ungroup()

load("0_data/manual/for_models/bd_cov_2023-03-16.rData")

bd_cov_processed<-bd_cov_2

save(bd_cov_processed, file=paste0("0_data/manual/for_models/bd_cov_processed_", Sys.Date(), ".rData"))

load("0_data/manual/for_models/bd_cov_processed_2023-03-16.rData")
```

## Scale data {-}

```{r eval=FALSE}
p1<-bd_cov_2
# reclassify columns 
## check classes
lapply(p1,class)

#Convert character variables to factors
p2<- as.data.frame(unclass(p1),                 
                       stringsAsFactors = TRUE)
p2$dist_to_edge<-as.numeric(p2$dist_to_edge)

lapply(p2,class)

# scale all numeric columns
p3<- p2%>%
  ungroup()%>%
   mutate(across(-c(SS:RaoQ,"yodConf","sumConf", "flag_pixels"), scale))

# check classes
lapply(p3, class)

bd_cov_processed_scaled<-p3

save(bd_cov_processed_scaled, file=paste0("0_data/manual/for_models/bd_cov_processed_scaled_", Sys.Date(), ".rData"))

load("0_data/manual/for_models/bd_cov_processed_scaled_2023-03-16.rData")
```

## Filter {-}
```{r eval=FALSE}
load("0_data/manual/for_models/bd_cov_processed_scaled_2023-03-16.rData")

# filter based on NBR confidence scores
bd_cov_processed_scaled_filtered<-bd_cov_processed_scaled%>%
  filter(survey_year>NBR_yod)%>%#3404
  filter(flag_pixels=="n")%>%
  filter(yodConf>3)

save(bd_cov_processed_scaled_filtered, file=paste0("0_data/manual/for_models/bd_cov_processed_scaled_filtered_", Sys.Date(), ".rData"))

load("0_data/manual/for_models/bd_cov_processed_scaled_filtered_2023-03-16.rData")
```





