```{r setup, include=FALSE, cache=FALSE}
#Set root directory to R project root
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

Load data. 

```{r}
# GEE landcover
load("2_pipeline/tmp/gee_metrics_3.rData")

# Harvest
load("0_data/manual/spatial/ss_xy_harvest_df_2023-03-08.rData")

# NBR
load("2_pipeline/tmp/ss_xy_abmiRegen_df.rData")

# Bird community
load("0_data/manual/bird/bd_community_2023-02-10.rData")

# NBR from CAS-FRI
load("0_data/manual/spatial/spatial_cov.rData")
```


Join bird data and spatial data

```{r eval=FALSE}
# test<-abmi_regen%>%
#   dplyr::select(-c( "OBJECTID","SOURCE","AnlysID", "geometry"))%>%
#   distinct()


gee_metrics_3<-gee_metrics_3%>%
  dplyr::rename(survey_year=srvy_yr)

ss_cas<-ss_xy_harvest_df%>%dplyr::select(SS, survey_year, cas_id)

bd_cov<-bd_community%>%
  left_join(gee_metrics_3, by = c("SS", "survey_year"))%>%
  left_join(ss_cas, by = c("SS", "survey_year"))%>%
  distinct()%>%
    # left_join(ss_xy_harvest_df, by = c("SS", "survey_year"))%>%
  dplyr::select(-c(x, y))%>%
  mutate(sampling_intensity=MAXDUR*n_count)%>%#calculate n of sampling minutes (for sampling_intensity)
  # left_join(ss_xy_abmiRegen_df)%>%distinct()%>%
  left_join(spatial_cov, by=c("SS", "cas_id", "survey_year"))

bd_cov<-bd_cov%>%
  # add timelag columns
  mutate(ss_dst_timelag=survey_year-round(dist_yr_1, 0))%>%
  mutate(ss_dst_timelag_nbr=survey_year-round(yod, 0))%>%
  mutate(dist_date_dif=ss_dst_timelag_nbr-ss_dst_timelag)

## add sampling intensity column
# bd_cov<-bd_cov%>%
#   group_by(SS, survey_year)%>%
#   mutate(n_samples=n())

# save(bd_cov, file=paste0("0_data/manual/for_models/bd_cov.rData", Sys.Date(), ".rData")
bd_cov_2<-bd_cov
save(bd_cov_2, file=paste0("0_data/manual/for_models/bd_cov_2_", Sys.Date(), ".rData"))

load("0_data/manual/for_models/bd_cov_2_2023-03-08.rData")

###filter  
# %>%
#   filter(!is.na(ss_dst_timelag))
```

Filter data
```{r eval=FALSE}

bd_cov_f<-bd_cov_2%>%
  # filter( dist_1=="CO" & is.na(dist_2))
filter( dist_1=="CO" & is.na(dist_2) & ss_dst_timelag_nbr>0)

# filter(is.na(dist_2))  
```

Scale data

```{r eval=FALSE}

p1<-bd_cov_f%>%
  rename(Wetland_treed="Wetland-treed")%>%
  dplyr::select(SS, cas_id, survey_year, sampling_intensity, richness, menhIndx, margIndx, shan, brill, simp, pilou, hill, FRic, qual.FRic, FEve, FDiv, FDis, RaoQ, Shape_Area, PA_ratio, species_1, species_per_1, ss_dst_timelag, ss_dst_timelag_nbr,dist_to_edge, dNBR, RdNBR, dNBR_recovery, NBR_survey, dNBR_perc, dist_ext_upper_1, Coniferous,Exposed_Barren_land, Herbs, Mixedwood, Shrubs,  Water, Wetland, Wetland_treed,
canopy_height, canopy_standard_deviation,
lat) %>%
  distinct()

# %>%
#   na.omit()

# d3$dist_cont<-as.character(d3$dist_ext_upper_1)
# d3$dist_cont<-d3$dist_cont
# 
# d3$treatment<-paste(d3$dist_ext_upper_1, d3$ss_dst_timelag_range, sep="__")
# d3$treatment<-as.factor(d3$treatment)

# reclassify columns 
## check classes
lapply(p1,class)

# turn survey year into a categorical variable
p1$dist_to_edge<-as.numeric(p1$dist_to_edge)

#Convert character variables to factors
p2<- cbind(p1[1:2],as.data.frame(unclass(p1[c(3:ncol(p1))]),                 
                       stringsAsFactors = TRUE))

# scale all numeric columns
p3<- p2%>%
  ungroup()%>%
   mutate(across(-c(SS:RaoQ,dist_ext_upper_1, species_1), scale))

# check classes
lapply(p3, class)

# p2$lat<-scale(p2$lat, center = TRUE, scale = TRUE)


# # scale CAS-FRI predictors
# p2$dist_to_edge<-scale(p2$dist_to_edge, center = TRUE, scale = TRUE)
# p2$Shape_Area<-scale(p2$Shape_Area , center = TRUE, scale = TRUE)
# p2$PercentConif<-scale(p2$PercentConif, center = TRUE, scale = TRUE)
# p2$PA_ratio<-scale(p2$PA_ratio, center = TRUE, scale = TRUE)
# p2$PercentDecid<-scale(p2$PercentDecid, center = TRUE, scale = TRUE)
# p2$ss_dst_timelag<-scale(p2$ss_dst_timelag, center = TRUE, scale = TRUE)
# p2$species_per_1<-scale(p2$species_per_1, center = TRUE, scale = TRUE)
# 
# #scale NBR
# p2$dNBR<-scale(p2$dNBR, center=TRUE, scale=TRUE)
# p2$RdNBR<-scale(p2$RdNBR, center=TRUE, scale=TRUE)
# p2$dNBR_recovery<-scale(p2$dNBR_recovery, center=TRUE, scale=TRUE)
# p2$NBR_survey<-scale(p2$NBR_survey, center=TRUE, scale=TRUE)
# p2$dNBR_perc<-scale(p2$dNBR_perc, center=TRUE, scale=TRUE)
# p2$ss_dst_timelag_NBR<-scale(p2$ss_dst_timelag_NBR, center = TRUE, scale = TRUE)
# 

d<-p3%>%
  na.omit()

save(d, file=paste0("0_data/manual/for_models/bd_cov_processed_", Sys.Date(), ".rData"))

load("0_data/manual/for_models/bd_cov_processed_2023-03-08.rData")
```




